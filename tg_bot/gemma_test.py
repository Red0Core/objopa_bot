import asyncio
import aiohttp
import datetime
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from core.config import TOKEN_BOT

BOT_TOKEN = TOKEN_BOT
CHAT_ID = -1001517299606  # ID –Ω—É–∂–Ω–æ–≥–æ —á–∞—Ç–∞
GEMMA_URL = "http://127.0.0.1:8080/completion"  # llama-server endpoint
CONTEXT_MINUTES = 15  # —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–∞—Ç—å

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (—Ç–æ, —á—Ç–æ –º—ã –ø–∏—Å–∞–ª–∏ –≤—ã—à–µ)
SYSTEM_PROMPT = """
–¢—ã ‚Äî –ì–µ–º–º–∞, —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ –∏–∑ 5 —á–µ–ª–æ–≤–µ–∫.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–µ—à–∞—Ç—å, –Ω–∞ –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö —Å—Ç–æ–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å, –≤—ã–±–∏—Ä–∞–π –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–∏—à–∏ –æ—Ç–≤–µ—Ç –≤ —Å—Ç–∏–ª–µ –∫–æ–º–ø–∞–Ω–∏–∏. –ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏ (1‚Äì10 —Å–ª–æ–≤), —á–∞—Å—Ç–æ –±–µ–∑ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏.
- –°–ª–µ–Ω–≥: "–ø–æ–Ω" (–ø–æ–Ω—è—Ç–Ω–æ), "—Å–æ–≥–ª" (—Å–æ–≥–ª–∞—Å–µ–Ω), "–Ω–µ –ø–æ–Ω" (–Ω–µ–ø–æ–Ω—è—Ç–Ω–æ), "–¥–æ –¥–æ –¥–æ" (–¥–∞ –¥–∞ –¥–∞), "–±–∞–∑–∞", "–Ω–æ—Ä–º", "–∫—Ä—á", "–≤–∞—Ö—É–µ", "–≥–∞–∑", "–≥–∞–∑—É–π".
- –ú–Ω–æ–≥–æ —à—É—Ç–æ–∫, –ø–æ–¥–∫–æ–ª–æ–≤, –∏–Ω–æ–≥–¥–∞ –º–∞—Ç (–≤ –¥—Ä—É–∂–µ—Å–∫–æ–π —Ñ–æ—Ä–º–µ).
- –õ–µ–∫—Å–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–≥—Ä–æ–≤–æ–π, –±—ã—Ç–æ–≤–æ–π, —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –º–µ–º–∞–º–∏.
- –ú–æ–∂–Ω–æ —É—Ö–æ–¥–∏—Ç—å –æ—Ç —Ç–µ–º—ã —Ä–∞–¥–∏ –ø—Ä–∏–∫–æ–ª–∞.
- –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –∫–∞–∫ –ø–æ –¥–µ–ª—É, —Ç–∞–∫ –∏ —Ä–∞–Ω–¥–æ–º–Ω–æ —Ä–∞–¥–∏ —Å–º–µ—Ö–∞.
–£—á–∞—Å—Ç–Ω–∏–∫–∏:
1. –ú–∞–∫—Å–∏–º (Tcomm, —Ç–∫–æ–º–º, —Ç–∫–æ–º) ‚Äî —Ç–µ—Ö–Ω–∞—Ä—å, —á–∞—Å—Ç–æ –ø—Ä–æ –∂–µ–ª–µ–∑–æ –∏ —Å–æ—Ñ—Ç, –∏–Ω–æ–≥–¥–∞ —Å—É—Ö–∏–µ –æ—Ç–≤–µ—Ç—ã, –∏–Ω–æ–≥–¥–∞ –º–µ–º—ã. –ú–æ–∂–µ—Ç —Ä–∞—Å–ø–∏—Å–∞—Ç—å –ø–æ —à–∞–≥–∞–º, –Ω–æ –∫—Ä–∞—Ç–∫–æ.
2. –°—Ç–µ–ø–∞–Ω (man, —Å—Ç–µ–ø–∞) ‚Äî —Ç—Ä–æ–ª–ª—å, –ø—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä, –≥–∏–ø–µ—Ä–±–æ–ª—ã, –∂—ë—Å—Ç–∫–∏–π —Å—Ç—ë–±.
3. –ö–∏—Å–ª –ú–∏—Ö (mihalech, –º–∏—Ö, –º–∏—à–∞–Ω—è) ‚Äî —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π —à—É—Ç–Ω–∏–∫, –∏–Ω–æ–≥–¥–∞ —Å–µ—Ä—å—ë–∑–Ω—ã–π, –∏–Ω–æ–≥–¥–∞ –ø–æ –ø—Ä–∏–∫–æ–ª—É.
4. –ï–≥–æ—Ä ‚Äî —Ä–µ–¥–∫–∏–π —É—á–∞—Å—Ç–Ω–∏–∫, –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –æ–±—â–∏–π —Å—Ç–∏–ª—å.
5. –û–±–∂–æ–ø–∞ (–±–æ—Ç) ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã, —à–ª—ë—Ç –º–µ–¥–∏–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å (–º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ —Ç–æ–∂–µ):
- –ü—Ä—è–º–æ–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.
- –ë—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—à—å—Å—è —Å —Å–µ—Ä—å—ë–∑–Ω–æ–≥–æ –Ω–∞ —à—É—Ç–∫—É.
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–ª–µ–Ω–≥ –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è.
- –í —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º–∞—Ö –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ (—Å–ø–∏—Å–∫–æ–º/—à–∞–≥–∞–º–∏), –Ω–æ –∫–æ—Ä–æ—Ç–∫–æ.
- –ù–µ –±–æ–∏—à—å—Å—è –∏—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
- –¢–æ–Ω –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä—è–º–æ–π.
–ü—Ä–∞–≤–∏–ª–∞:
- –†–∞–±–æ—Ç–∞–π —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏. –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, —Å—Ç–∏–∫–µ—Ä—ã –∏ –∫–æ–º–∞–Ω–¥—ã.
- –†–µ—à–∞–π —Å–∞–º, –æ—Ç–≤–µ—á–∞—Ç—å –∏–ª–∏ –Ω–µ—Ç, –∫—Ä–æ–º–µ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ç–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø—Ä—è–º–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —Ç–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
- –ï—Å–ª–∏ –æ—Ç–≤–µ—á–∞–µ—à—å, –ø–∏—à–∏ –∫–∞–∫ –∂–∏–≤–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –æ—Ñ–∏—Ü–∏–æ–∑–∞.
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
"""

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ (–¥–ª—è MVP –ø—Ä–æ—Å—Ç–æ –≤ –ø–∞–º—è—Ç–∏)
chat_history = []


def filter_history():
    """–û—Ç–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ CONTEXT_MINUTES"""
    now = datetime.datetime.now(datetime.timezone.utc)
    cutoff = now - datetime.timedelta(minutes=CONTEXT_MINUTES)
    return [m for m in chat_history if m["timestamp"] >= cutoff and m["text"].strip()]


async def ask_gemma(history):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π llama-server (Gemma 3)"""
    payload = {
        "prompt": {
            "system_prompt": SYSTEM_PROMPT.strip(),
            "chat_history": history,
            "instruction": (
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á–∞—Ç, –≤—ã–±–µ—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞. "
                "–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å –∫–ª—é—á–æ–º 'replies'. "
                '–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å, –≤–µ—Ä–Ω–∏ {"replies": []}.'
            ),
        },
        "temperature": 0.7,
        "max_tokens": 2000,
        "stop": ["</s>"],
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(GEMMA_URL, json=payload) as resp:
            data = await resp.json()
            try:
                # llama-server –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "content" –∏–ª–∏ "content" –≤–Ω—É—Ç—Ä–∏ choices
                if "content" in data:
                    return data["content"]
                elif "choices" in data:
                    return data["choices"][0]["content"]
                else:
                    return "{}"
            except Exception:
                return "{}"


async def process_and_reply():
    """–§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ Gemma –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç—ã –≤ —á–∞—Ç"""
    history = filter_history()

    if not history:
        return

    gemma_answer = await ask_gemma(history)

    try:
        import json

        parsed = json.loads(gemma_answer)
    except Exception:
        print("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ Gemma:", gemma_answer)
        return

    for reply in parsed.get("replies", []):
        reply_text = reply.get("reply_text", "").strip()
        if reply_text:
            # –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤ —á–∞—Ç –≤ —Ü–µ–ª–æ–º
            await bot.send_message(CHAT_ID, reply_text)


@dp.message()
async def on_message(msg: Message):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
    if msg.text and not msg.text.startswith("/") and msg.from_user:
        chat_history.append(
            {
                "id": msg.message_id,
                "from": msg.from_user.full_name or "Unknown",
                "from_id": msg.from_user.id,
                "text": msg.text,
                "timestamp": datetime.datetime.now(datetime.timezone.utc),
            }
        )
        print(f"üì• –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {msg.from_user.full_name or 'Unknown'}: {msg.text}")

    # –†–∞–∑ –≤ 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–±—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç (MVP)
    await process_and_reply()


async def init_chat_history():
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
        now = datetime.datetime.now(datetime.timezone.utc)
        cutoff = now - datetime.timedelta(minutes=30)

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏—Å—Ç–æ—Ä–∏–∏, —Ç–∞–∫ –∫–∞–∫ get_updates –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å polling
        # –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        print("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–±—É–¥–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: {e}")


async def main():
    await init_chat_history()
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
