from aiogram import Bot, Router
from aiogram.filters import Command
from aiogram.types import Message

from core.config import GEMINI_API_KEY
from tg_bot.services.gpt import (
    AIModelError,
    APIKeyError,
    GeminiModel,
    QuotaExceededError,
    RateLimitError,
    UnexpectedResponseError,
    get_gpt_formatted_chunks,
)

router = Router()
AI_CLIENT = GeminiModel(api_key=GEMINI_API_KEY)


@router.message(Command("dice"))
async def handle_mention(message: Message, bot: Bot):
    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    await message.reply("–°–µ–π—á–∞—Å —è —Ä–µ—à—É —ç—Ç–æ —Å –ø–æ–º–æ—â—å—é –∫—É–±–∏–∫–∞! üé≤")

    # –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫
    dice_message = await bot.send_dice(message.chat.id)
    dice_value = dice_message.dice.value  # –ó–Ω–∞—á–µ–Ω–∏–µ –∫—É–±–∏–∫–∞ (1-6) # type: ignore[union-attr]
    text = message.text.split(maxsplit=1)[1] if message.text else ""

    system_prompt = """–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∏ –≤–µ—Å—ë–ª—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏.
–¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —Å –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º –∏ –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏. –ö–æ—Ä–æ—Ç–∫–æ: 1‚Äì2 –∞–±–∑–∞—Ü–∞, –±–µ–∑ —Ç—è–∂—ë–ª–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

–õ–æ–≥–∏–∫–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:
1) –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø:
   - ¬´–í—ã–±–æ—Ä¬ª: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã (–µ—Å—Ç—å —Å–ª–æ–≤–∞ ¬´–∏–ª–∏¬ª, ¬´–º–µ–∂–¥—É¬ª, –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é/–Ω—É–º–µ—Ä–∞—Ü–∏—é).
   - ¬´–û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ¬ª: –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π, –≥–¥–µ –Ω–∞–¥–æ —Ä–µ—à–∏—Ç—å ‚Äî –¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–µ –¥–µ–ª–∞—Ç—å.
2) –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—É–±–∏–∫–∞ (—á–∏—Å–ª–æ 1‚Äì6) –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –∑–∞–ø—Ä–æ—Å–µ. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è.

–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è:
- –ï—Å–ª–∏ ¬´–í—ã–±–æ—Ä¬ª:
  - –ï—Å–ª–∏ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞: 1‚Äì3 ‚Üí –≤—ã–±–∏—Ä–∞–π –ø–µ—Ä–≤—ã–π; 4‚Äì6 ‚Üí –≤—ã–±–∏—Ä–∞–π –≤—Ç–æ—Ä–æ–π.
  - –ï—Å–ª–∏ 3+ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º ((–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É–±–∏–∫–∞ ‚àí 1) mod N) + 1.
- –ï—Å–ª–∏ ¬´–û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ¬ª:
  - 1‚Äì3 ‚Üí ¬´–î–µ–ª–∞—Ç—å¬ª. –ü–æ–¥–¥–µ—Ä–∂–∏ –∏–¥–µ—é, –¥–∞–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.
  - 4‚Äì6 ‚Üí ¬´–ù–µ –¥–µ–ª–∞—Ç—å¬ª. –û—Ç–≥–æ–≤–æ—Ä–∏ —Å –¥–æ–±—Ä—ã–º —é–º–æ—Ä–æ–º –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –° –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —á—ë—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π —Ä–µ—à–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ: ¬´–í—ã–±–æ—Ä: <–≤–∞—Ä–∏–∞–Ω—Ç>¬ª –∏–ª–∏ ¬´–†–µ—à–µ–Ω–∏–µ: –¥–µ–ª–∞—Ç—å/–Ω–µ –¥–µ–ª–∞—Ç—å¬ª.
- –î–∞–ª—å—à–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (1‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –æ—á–µ–Ω—å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ –∏ –ø–æ –¥–µ–ª—É.
- –ò–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤, –Ω–æ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤—É–π emoji, –≤ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–µ–º–æ–Ω–∞, –∫—Ä—É—Ç–æ–π —á—É–≤–∞–∫, üí™ –∏ —Ç.–¥. –ù–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–π —Ç–µ–∫—Å—Ç. 
- MarkdownV2 —Ä–∞–∑—Ä–µ—à–µ–Ω.
"""

    action_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥—É–º–∞–ª—Å—è –æ —Å–ª–µ–¥—É—é—â–µ–º: "{text}". –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª {dice_value}. –ù–∞–ø–∏—à–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∏ –≤–µ—Å—ë–ª—ã–π —Ç–µ–∫—Å—Ç"""

    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OpenAI API
        text = await AI_CLIENT.get_response(action_prompt, system_prompt)
        for chunk in get_gpt_formatted_chunks(text):
            await message.reply(chunk, parse_mode="MarkdownV2")
    except APIKeyError:
        await message.reply("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
    except RateLimitError:
        await message.reply("–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    except QuotaExceededError:
        await message.reply("–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API.")
    except UnexpectedResponseError:
        await message.reply("–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    except AIModelError as e:
        await message.reply(f"–û—à–∏–±–∫–∞: {str(e)}")
